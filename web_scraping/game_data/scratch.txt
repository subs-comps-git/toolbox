import sqlite3

from get_gp_data import get_html, make_soup, make_gp_list
from load_into_sql import create_database, create_schema, load_data, print_data

html_data = get_html('https://swgoh.gg/g/11008/hansoloshotfirst/gp/')

swgoh_soup = make_soup(html_data, 'html5lib')

gp = make_gp_list(swgoh_soup)
insert_gp ="""
INSERT INTO gp
 (u_id, dl_date, total_gp, char_gp, ship_gp) 
VALUES 
 ((SELECT uid FROM users WHERE name = ?), (strftime('%s', 'now')), ?, ?, ?);
"""

insert_names = 'INSERT INTO users (name) VALUES (?);'

create_schema('swgoh.db', 'swgoh.sql')


def connect_db(name):
    return sqlite3.connect(name)


def load_data(conn, gp_data, gp_sql, names_sql):
    cursor = conn.cursor()
    try:
        cursor.executemany(gp_sql, gp_data)
    except sqlite3.Error as e:
        for row in gp_data:
            cursor.execute(names_sql, (row[0],))
        cursor.executemany(gp_sql, gp_data)
    conn.commit()

get_data = """
SELECT (datetime(dl_date, 'unixepoch'), name, total_gp, char_gp, ship_gp)
 FROM gp
 JOIN users
 ON users.uid = gp.u_id
"""